---
interface Props {
  defaultColor?: string;
  steps?: number;
  showValues?: boolean;
  enableCopy?: boolean;
}

const {
  defaultColor = "#8b6a1d",
  steps = 24,
  showValues = true,
  enableCopy = true,
} = Astro.props;
---

<div class="color-brightness-container">
  <div class="input-section">
    <label for="color-input">Enter a hex color:</label>
    <input
      type="text"
      id="color-input"
      placeholder="#8b6a1d"
      value={defaultColor}
      maxlength="7"
    />
  </div>

  <div id="swatches-container" class="swatches-container">
    <!-- Swatches generated by JavaScript -->
  </div>

  <div id="notification" class="notification" role="status" aria-live="polite">
    Color copied!
  </div>
</div>

<script>
  // Color conversion utilities

  function hexToRgb(hex: string): { r: number; g: number; b: number } | null {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result
      ? {
          r: parseInt(result[1], 16),
          g: parseInt(result[2], 16),
          b: parseInt(result[3], 16),
        }
      : null;
  }

  function rgbToHsl(
    r: number,
    g: number,
    b: number,
  ): { h: number; s: number; l: number } {
    r /= 255;
    g /= 255;
    b /= 255;
    const max = Math.max(r, g, b);
    const min = Math.min(r, g, b);
    let h = 0,
      s = 0,
      l = (max + min) / 2;

    if (max !== min) {
      const d = max - min;
      s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
      switch (max) {
        case r:
          h = ((g - b) / d + (g < b ? 6 : 0)) / 6;
          break;
        case g:
          h = ((b - r) / d + 2) / 6;
          break;
        case b:
          h = ((r - g) / d + 4) / 6;
          break;
      }
    }

    return { h: h * 360, s: s * 100, l: l * 100 };
  }

  function hslToRgb(
    h: number,
    s: number,
    l: number,
  ): { r: number; g: number; b: number } {
    h /= 360;
    s /= 100;
    l /= 100;

    let r, g, b;
    if (s === 0) {
      r = g = b = l;
    } else {
      const hue2rgb = (p: number, q: number, t: number) => {
        if (t < 0) t += 1;
        if (t > 1) t -= 1;
        if (t < 1 / 6) return p + (q - p) * 6 * t;
        if (t < 1 / 2) return q;
        if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
        return p;
      };
      const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
      const p = 2 * l - q;
      r = hue2rgb(p, q, h + 1 / 3);
      g = hue2rgb(p, q, h);
      b = hue2rgb(p, q, h - 1 / 3);
    }

    return {
      r: Math.round(r * 255),
      g: Math.round(g * 255),
      b: Math.round(b * 255),
    };
  }

  function rgbToHex(r: number, g: number, b: number): string {
    return (
      "#" +
      [r, g, b]
        .map((x) => {
          const hex = x.toString(16);
          return hex.length === 1 ? "0" + hex : hex;
        })
        .join("")
    );
  }

  // Core logic

  function generateBrightnessSteps(
    hexColor: string,
    numSteps: number,
  ): Array<{ hex: string; isOriginal: boolean }> {
    const rgb = hexToRgb(hexColor);
    if (!rgb) return [];

    const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
    const swatches: Array<{
      hex: string;
      isOriginal: boolean;
      lightness: number;
    }> = [];

    // Generate lightness values from 95% down to 5%
    for (let i = 0; i < numSteps; i++) {
      const lightness = 95 - (90 / (numSteps - 1)) * i;
      const adjustedRgb = hslToRgb(hsl.h, hsl.s, lightness);
      const hex = rgbToHex(adjustedRgb.r, adjustedRgb.g, adjustedRgb.b);
      swatches.push({ hex, isOriginal: false, lightness });
    }

    // Insert the original color at the appropriate position
    const originalLightness = hsl.l;
    let insertIndex = swatches.findIndex(
      (s) => s.lightness < originalLightness,
    );
    if (insertIndex === -1) insertIndex = swatches.length;

    swatches.splice(insertIndex, 0, {
      hex: hexColor,
      isOriginal: true,
      lightness: originalLightness,
    });

    return swatches;
  }

  function isValidHex(color: string): boolean {
    return /^#?([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(color);
  }

  function normalizeHex(hex: string): string {
    let normalized = hex.startsWith("#") ? hex : "#" + hex;
    if (normalized.length === 4) {
      normalized =
        "#" +
        normalized[1] +
        normalized[1] +
        normalized[2] +
        normalized[2] +
        normalized[3] +
        normalized[3];
    }
    return normalized;
  }

  function copyToClipboard(text: string) {
    navigator.clipboard.writeText(text).then(() => {
      const notification = document.getElementById("notification");
      notification!.classList.add("show");
      setTimeout(() => {
        notification!.classList.remove("show");
      }, 2000);
    });
  }

  function renderSwatches(hexColor: string) {
    const swatchesContainer = document.getElementById("swatches-container");

    if (!isValidHex(hexColor)) {
      swatchesContainer!.innerHTML = '<p class="error">Invalid hex color</p>';
      return;
    }

    const normalizedHex = normalizeHex(hexColor);
    const swatches = generateBrightnessSteps(normalizedHex, 24);

    // Find the original color index
    const originalIndex = swatches.findIndex((s) => s.isOriginal);

    swatchesContainer!.innerHTML = swatches
      .map((swatch, index) => {
        // Calculate step relative to original (0 at original, + for brighter, - for darker)
        const stepNumber = originalIndex - index;
        const stepLabel =
          stepNumber === 0
            ? "0"
            : stepNumber > 0
              ? `+${stepNumber}`
              : `${stepNumber}`;
        return `
      <div class="swatch ${swatch.isOriginal ? "swatch-original" : ""}" data-color="${swatch.hex}" role="button" tabindex="0" aria-label="Step ${stepLabel}, Color ${swatch.hex}${swatch.isOriginal ? " (original)" : ""}" style="background-color: ${swatch.hex}">
        <span class="step-counter">${stepLabel}</span>
        <span class="swatch-value">
          ${swatch.hex}
        </span>
      </div>
    `;
      })
      .join("");
  }

  // Event listeners

  const colorInput = document.getElementById("color-input") as HTMLInputElement;
  const swatchesContainer = document.getElementById("swatches-container");

  colorInput!.addEventListener("input", (e: Event) => {
    const target = e.target as HTMLInputElement;
    const value = target.value.trim();

    if (value.length >= 3) {
      renderSwatches(value);
    }
  });

  // Event delegation for swatch interactions
  swatchesContainer!.addEventListener("click", (e: Event) => {
    const target = e.target as HTMLElement;
    const swatch = target.closest(".swatch");
    if (swatch) {
      const color = swatch.getAttribute("data-color")!;
      copyToClipboard(color);
    }
  });

  swatchesContainer!.addEventListener("keydown", (e: Event) => {
    const keyEvent = e as KeyboardEvent;
    const target = keyEvent.target as HTMLElement;
    if (
      target.classList.contains("swatch") &&
      (keyEvent.key === "Enter" || keyEvent.key === " ")
    ) {
      keyEvent.preventDefault();
      const color = target.getAttribute("data-color")!;
      copyToClipboard(color);
    }
  });

  // Initial render
  renderSwatches(colorInput!.value);
</script>

<style lang="scss" is:global>
  .color-brightness-container {
    max-width: 600px;
    margin: 0 auto;
    padding: var(--global-padding-default) 0;
  }

  .input-section {
    margin-bottom: 32px;

    label {
      display: block;
      font-size: 1.125rem;
      margin-bottom: 12px;
      color: var(--main-color);
    }

    input[type="text"] {
      width: 100%;
      padding: 16px 20px;
      font-size: 1.5rem;
      font-family: var(--fontFamily);
      border: 2px solid color-mix(in srgb, var(--main-color) 30%, transparent);
      border-radius: 12px;
      background-color: var(--background-color);
      color: var(--main-black);
      transition: border-color 0.2s ease-out;

      &:focus {
        outline: none;
        border-color: var(--main-color);
      }

      &::placeholder {
        color: color-mix(in srgb, var(--main-color) 40%, transparent);
      }

      @media (prefers-color-scheme: dark) {
        background-color: color-mix(
          in srgb,
          var(--main-color) 10%,
          transparent
        );
      }
    }
  }

  .swatches-container {
    display: grid;
    grid-template-columns: 1fr;

    .error {
      color: var(--contrast-color);
      text-align: center;
      padding: 20px;
      font-size: 1.125rem;
    }
  }

  .swatch {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 24px;
    min-height: 60px;
    cursor: pointer;
    transition:
      transform 0.1s ease-out,
      box-shadow 0.15s ease-out;

    &:active {
      transform: scale(1.1);
    }

    &:focus-within {
      // outline: 2px solid #fff;
    }

    @media (hover: hover) {
      &:hover {
        transform: scale(1.075);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
    }

    &:active {
      opacity: 0.9;
      transform: scale(1.05);
    }

    &:first-child {
      border-radius: 12px 12px 0 0;
    }

    &:last-child {
      border-radius: 0 0 12px 12px;
    }

    &.swatch-original {
      box-shadow: 0 0 0 3px
        color-mix(in srgb, var(--main-color) 20%, transparent);
      transform: scale(1.05);
    }

    .step-counter {
      font-size: 1rem;
      padding: 6px 12px;
      border-radius: 6px;
      background-color: rgba(255, 255, 255, 0.6);
      color: #000;
      backdrop-filter: blur(4px);
      min-width: 40px;
      text-align: center;
      opacity: 0;
      transition: opacity 0.2s ease-out;

      @media (prefers-color-scheme: dark) {
        background-color: rgba(0, 0, 0, 0.7);
        color: #fff;
      }
    }

    @media (hover: hover) {
      &:hover .step-counter {
        opacity: 1;
      }
    }

    .swatch-value {
      font-size: 1rem;
      user-select: all;
      padding: 8px 16px;
      border-radius: 6px;
      background-color: rgba(255, 255, 255, 0.6);
      color: #000;
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      gap: 8px;

      @media (prefers-color-scheme: dark) {
        background-color: rgba(0, 0, 0, 0.75);
        color: #fff;
      }
    }
  }

  .notification {
    position: fixed;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background-color: var(--main-color);
    color: white;
    padding: 16px 32px;
    border-radius: 32px;
    font-size: 1rem;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease-out;
    z-index: 1000;

    &.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }

  // MEDIUM SIZE SCREENS
  @media only screen and (max-width: 1100px) {
    .swatch {
      min-height: 60px;
      padding: 20px;

      .step-counter {
        font-size: 0.9rem;
        padding: 5px 10px;
        min-width: 36px;
      }

      .swatch-value {
        font-size: 1rem;
      }
    }
  }

  // SMALL SIZE SCREENS
  @media only screen and (max-width: 640px) {
    .color-brightness-container {
      padding: var(--global-padding-small) 0;
    }

    .swatch {
      min-height: 50px;
      padding: 16px;

      .step-counter {
        font-size: 0.8rem;
        padding: 4px 8px;
        min-width: 32px;
      }

      .swatch-value {
        font-size: 0.875rem;
        padding: 6px 12px;
        gap: 6px;

        .original-indicator {
          font-size: 0.65rem;
          padding: 2px 4px;
        }
      }
    }
  }
</style>
